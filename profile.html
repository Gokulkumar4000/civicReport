<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Profile</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="./styles.css">
</head>
<body class="bg-background-dark">
<div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
<div class="flex-grow">
<header class="header flex items-center justify-between px-4 py-3">
<button class="flex size-8 items-center justify-center rounded-full text-zinc-900">
<svg fill="currentColor" height="24" viewBox="0 0 256 256" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
</svg>
</button>
<h1 class="text-lg font-bold text-zinc-900">Profile</h1>
<div class="w-10"></div>
</header>
<main class="p-4">
<div id="loading-profile" class="text-center py-8">
<p class="text-zinc-500">Loading profile...</p>
</div>
<section id="profile-section" class="mb-8 flex flex-col items-center gap-4 hidden">
<div id="profile-avatar" class="h-32 w-32 rounded-full bg-gray-300 flex items-center justify-center">
<span class="material-symbols-outlined text-gray-500 text-4xl">person</span>
</div>
<div class="text-center">
<h2 id="profile-name" class="text-2xl font-bold text-zinc-900">Loading...</h2>
<p class="text-zinc-500">Your profile</p>
<p id="profile-joined" class="text-sm text-zinc-500">Joined recently</p>
</div>
</section>
<section class="space-y-6">
<div class="rounded-lg bg-white p-4">
<div class="flex items-center justify-between">
<div>
<h3 class="font-medium text-zinc-900">Profile visibility</h3>
<p id="visibility-description" class="text-sm text-zinc-500">Visible to everyone</p>
</div>
<label class="toggle-switch">
<input id="profile-visibility-toggle" class="toggle-input" type="checkbox"/>
<div class="toggle-bg"></div>
<div class="toggle-thumb"></div>
</label>
</div>
</div>
<div class="rounded-lg bg-white p-4">
<h3 class="mb-4 text-lg font-bold text-zinc-900">Personal details</h3>
<div id="personal-details" class="space-y-4">
<!-- Details will be loaded here -->
</div>
</div>
<div class="rounded-lg bg-white p-4">
<h3 class="mb-4 text-lg font-bold text-zinc-900">My Reports</h3>
<div id="user-reports-summary">
<!-- Reports summary will be loaded here -->
</div>
</div>

<div class="rounded-lg bg-white p-4 mt-4">
<h3 class="mb-4 text-lg font-bold text-zinc-900">Account Actions</h3>
<div class="space-y-3">
<button id="logout-btn" class="w-full flex items-center justify-center gap-2 p-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
<span class="material-symbols-outlined">logout</span>
<span class="font-medium">Sign Out</span>
</button>
</div>
</div>
</section>
</main>
</div>
<footer class="footer">
<nav class="flex justify-around items-center h-16">
<a class="nav-item" href="./index.html">
<span class="material-symbols-outlined">home</span>
<span class="text-xs font-bold">Home</span>
</a>
<a class="nav-item" href="./report.html">
<span class="material-symbols-outlined">description</span>
<span class="text-xs font-medium">Report</span>
</a>
<a class="nav-item" href="./post.html">
<span class="material-symbols-outlined">photo_camera</span>
<span class="text-xs font-medium">Camera</span>
</a>
<a class="nav-item active" href="./profile.html">
<span class="material-symbols-outlined">person</span>
<span class="text-xs font-medium">Profile</span>
</a>
</nav>
</footer>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', async function() {
  const loadingProfile = document.getElementById('loading-profile');
  const profileSection = document.getElementById('profile-section');
  const profileAvatar = document.getElementById('profile-avatar');
  const profileName = document.getElementById('profile-name');
  const profileJoined = document.getElementById('profile-joined');
  const personalDetails = document.getElementById('personal-details');
  const userReportsSummary = document.getElementById('user-reports-summary');
  const profileVisibilityToggle = document.getElementById('profile-visibility-toggle');
  const visibilityDescription = document.getElementById('visibility-description');
  const logoutBtn = document.getElementById('logout-btn');
  
  // Wait for Firebase to initialize and check authentication
  await new Promise(resolve => {
    const checkReady = () => {
      if (window.authManager && window.reportManager) {
        resolve();
      } else {
        setTimeout(checkReady, 100);
      }
    };
    checkReady();
  });
  
  // Check authentication
  setTimeout(async () => {
    if (!window.authManager.isAuthenticated()) {
      alert('Please login to view your profile');
      window.location.href = './login.html';
      return;
    }
    
    await loadProfile();
  }, 1000); // Give time for auth state to load
  
  async function loadProfile() {
    try {
      // Get current user data
      const userData = await window.authManager.getCurrentUserData();
      if (!userData) {
        throw new Error('Could not load user data');
      }
      
      // Update profile display
      profileName.textContent = userData.name || 'Unknown User';
      
      if (userData.createdAt) {
        const joinDate = new Date(userData.createdAt.toDate()).getFullYear();
        profileJoined.textContent = `Joined ${joinDate}`;
      }
      
      // Update avatar
      if (userData.profilePicture) {
        profileAvatar.innerHTML = `<img src="${userData.profilePicture}" alt="Profile" class="h-32 w-32 rounded-full object-cover">`;
      } else {
        const initial = userData.name ? userData.name.charAt(0).toUpperCase() : '?';
        profileAvatar.innerHTML = `<div class="h-32 w-32 rounded-full bg-primary flex items-center justify-center text-white text-4xl font-bold">${initial}</div>`;
      }
      
      // Update profile visibility toggle
      profileVisibilityToggle.checked = userData.profileVisible;
      visibilityDescription.textContent = userData.profileVisible ? 'Visible to everyone' : 'Anonymous to others';
      
      // Update personal details
      personalDetails.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-zinc-900">Name</p>
            <p class="text-sm text-zinc-500">${userData.name || 'Not provided'}</p>
          </div>
        </div>
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-zinc-900">Email</p>
            <p class="text-sm text-zinc-500">${userData.email || 'Not provided'}</p>
          </div>
        </div>
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-zinc-900">Phone</p>
            <p class="text-sm text-zinc-500">${userData.phone || 'Not provided'}</p>
          </div>
        </div>
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-zinc-900">Aadhar Card</p>
            <p class="text-sm text-zinc-500">**** **** ${userData.aadharCard ? userData.aadharCard.slice(-4) : '****'}</p>
          </div>
        </div>
      `;
      
      // Load reports summary
      const userReports = await window.reportManager.getCurrentUserReports();
      const totalReports = userReports.length;
      const solvedReports = userReports.filter(r => r.status === 'Solved').length;
      const pendingReports = userReports.filter(r => r.status === 'Pending').length;
      
      userReportsSummary.innerHTML = `
        <div class="grid grid-cols-3 gap-4">
          <div class="text-center">
            <p class="text-2xl font-bold text-zinc-900">${totalReports}</p>
            <p class="text-sm text-zinc-500">Total Reports</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-green-600">${solvedReports}</p>
            <p class="text-sm text-zinc-500">Solved</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-yellow-600">${pendingReports}</p>
            <p class="text-sm text-zinc-500">Pending</p>
          </div>
        </div>
        <div class="mt-4 text-center">
          <a href="./report.html" class="text-primary font-semibold hover:underline">View All Reports â†’</a>
        </div>
      `;
      
      // Show profile section and hide loading
      loadingProfile.classList.add('hidden');
      profileSection.classList.remove('hidden');
      
    } catch (error) {
      console.error('Error loading profile:', error);
      loadingProfile.innerHTML = '<p class="text-red-500">Error loading profile. Please try again.</p>';
    }
  }
  
  // Profile visibility toggle
  profileVisibilityToggle.addEventListener('change', async function() {
    try {
      const isVisible = this.checked;
      await window.authManager.updateProfile({ profileVisible: isVisible });
      visibilityDescription.textContent = isVisible ? 'Visible to everyone' : 'Anonymous to others';
    } catch (error) {
      console.error('Error updating visibility:', error);
      alert('Error updating profile visibility. Please try again.');
      // Revert toggle
      this.checked = !this.checked;
    }
  });
  
  // Logout functionality
  logoutBtn.addEventListener('click', async function() {
    if (confirm('Are you sure you want to sign out?')) {
      try {
        await window.authManager.logout();
        window.location.href = './login.html';
      } catch (error) {
        console.error('Logout error:', error);
        alert('Error signing out. Please try again.');
      }
    }
  });
});
</script>
</body>
</html>