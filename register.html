<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Register - Incident Reports</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="./styles.css">
<script type="module" src="./firebase-config.js"></script>
</head>
<body class="bg-background-dark">
<div class="container min-h-screen flex items-center justify-center py-6">
<div class="bg-white rounded-xl p-6 w-full max-w-md">
<div class="text-center mb-6">
<span class="material-symbols-outlined text-primary text-4xl">location_on</span>
<h1 class="text-2xl font-bold text-zinc-900 mt-2">Create Account</h1>
<p class="text-zinc-500 mt-1">Join our incident reporting community</p>
</div>

<form id="register-form" class="space-y-4">
<div>
<label class="block text-sm font-medium text-zinc-700 mb-1">Full Name</label>
<input type="text" id="name" required class="w-full p-3 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
</div>

<div>
<label class="block text-sm font-medium text-zinc-700 mb-1">Email</label>
<input type="email" id="email" required class="w-full p-3 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
</div>

<div>
<label class="block text-sm font-medium text-zinc-700 mb-1">Phone Number</label>
<input type="tel" id="phone" required class="w-full p-3 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
</div>

<div>
<label class="block text-sm font-medium text-zinc-700 mb-1">Aadhar Card Number</label>
<input type="text" id="aadharCard" required maxlength="12" class="w-full p-3 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
</div>

<div>
<label class="block text-sm font-medium text-zinc-700 mb-1">Password</label>
<input type="password" id="password" required minlength="6" class="w-full p-3 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
<p class="text-xs text-zinc-500 mt-1">At least 6 characters</p>
</div>

<div>
<label class="block text-sm font-medium text-zinc-700 mb-1">Confirm Password</label>
<input type="password" id="confirmPassword" required class="w-full p-3 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
</div>

<div id="error-message" class="hidden p-3 bg-red-100 border border-red-300 rounded-lg text-red-700 text-sm"></div>

<button type="submit" id="register-btn" class="w-full btn-primary py-3">
Create Account
</button>
</form>

<div class="text-center mt-6">
<p class="text-zinc-600">Already have an account? 
<a href="./login.html" class="text-primary font-semibold hover:underline">Sign in</a>
</p>
</div>
</div>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', function() {
  const registerForm = document.getElementById('register-form');
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const phoneInput = document.getElementById('phone');
  const aadharCardInput = document.getElementById('aadharCard');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const registerBtn = document.getElementById('register-btn');
  const errorMessage = document.getElementById('error-message');

  // Check if user is already logged in
  window.authManager.setupAuthListener = function() {
    if (window.authManager.currentUser) {
      window.location.href = './index.html';
    }
  };

  registerForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    const phone = phoneInput.value.trim();
    const aadharCard = aadharCardInput.value.trim();
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    // Validation
    if (!name || !email || !phone || !aadharCard || !password || !confirmPassword) {
      showError('Please fill in all fields');
      return;
    }

    if (password !== confirmPassword) {
      showError('Passwords do not match');
      return;
    }

    if (password.length < 6) {
      showError('Password must be at least 6 characters');
      return;
    }

    if (aadharCard.length !== 12 || !/^\d+$/.test(aadharCard)) {
      showError('Aadhar card number must be 12 digits');
      return;
    }

    if (!/^\+?[\d\s\-\(\)]{10,}$/.test(phone)) {
      showError('Please enter a valid phone number');
      return;
    }

    // Show loading state
    registerBtn.disabled = true;
    registerBtn.textContent = 'Creating Account...';
    hideError();

    try {
      // Wait for Firebase to initialize
      await new Promise(resolve => {
        const checkReady = () => {
          if (window.authManager) {
            resolve();
          } else {
            setTimeout(checkReady, 100);
          }
        };
        checkReady();
      });

      const userData = {
        name,
        email,
        phone,
        aadharCard,
        password
      };

      await window.authManager.register(userData);
      
      // Show success message and redirect
      alert('Account created successfully! Welcome to Incident Reports.');
      window.location.href = './index.html';

    } catch (error) {
      console.error('Registration error:', error);
      let errorText = 'Registration failed. Please try again.';
      
      if (error.code === 'auth/email-already-in-use') {
        errorText = 'An account with this email already exists.';
      } else if (error.code === 'auth/invalid-email') {
        errorText = 'Invalid email address.';
      } else if (error.code === 'auth/weak-password') {
        errorText = 'Password is too weak. Please choose a stronger password.';
      }
      
      showError(errorText);
    } finally {
      registerBtn.disabled = false;
      registerBtn.textContent = 'Create Account';
    }
  });

  function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
  }

  function hideError() {
    errorMessage.classList.add('hidden');
  }
});
</script>
</body>
</html>