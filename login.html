<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Login - Incident Reports</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="./styles.css">
<script type="module" src="./firebase-config.js"></script>
</head>
<body class="bg-background-dark">
<div class="container min-h-screen flex items-center justify-center">
<div class="bg-white rounded-xl p-6 w-full max-w-md">
<div class="text-center mb-6">
<span class="material-symbols-outlined text-primary text-4xl">location_on</span>
<h1 class="text-2xl font-bold text-zinc-900 mt-2">Incident Reports</h1>
<p class="text-zinc-500 mt-1">Sign in to your account</p>
</div>

<form id="login-form" class="space-y-4">
<div>
<label class="block text-sm font-medium text-zinc-700 mb-1">Email</label>
<input type="email" id="email" required class="w-full p-3 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
</div>

<div>
<label class="block text-sm font-medium text-zinc-700 mb-1">Password</label>
<input type="password" id="password" required class="w-full p-3 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
</div>

<div id="error-message" class="hidden p-3 bg-red-100 border border-red-300 rounded-lg text-red-700 text-sm"></div>

<button type="submit" id="login-btn" class="w-full btn-primary py-3">
Sign In
</button>
</form>

<div class="text-center mt-6">
<p class="text-zinc-600">Don't have an account? 
<a href="./register.html" class="text-primary font-semibold hover:underline">Sign up</a>
</p>
</div>
</div>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', function() {
  const loginForm = document.getElementById('login-form');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const errorMessage = document.getElementById('error-message');

  // Check if user is already logged in
  window.authManager.setupAuthListener = function() {
    if (window.authManager.currentUser) {
      window.location.href = './index.html';
    }
  };

  loginForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!email || !password) {
      showError('Please fill in all fields');
      return;
    }

    // Show loading state
    loginBtn.disabled = true;
    loginBtn.textContent = 'Signing in...';
    hideError();

    try {
      // Wait for Firebase to initialize
      await new Promise(resolve => {
        const checkReady = () => {
          if (window.authManager) {
            resolve();
          } else {
            setTimeout(checkReady, 100);
          }
        };
        checkReady();
      });

      await window.authManager.login(email, password);
      
      // Redirect to home page
      window.location.href = './index.html';

    } catch (error) {
      console.error('Login error:', error);
      let errorText = 'Login failed. Please try again.';
      
      if (error.code === 'auth/user-not-found') {
        errorText = 'No account found with this email address.';
      } else if (error.code === 'auth/wrong-password') {
        errorText = 'Incorrect password.';
      } else if (error.code === 'auth/invalid-email') {
        errorText = 'Invalid email address.';
      } else if (error.code === 'auth/too-many-requests') {
        errorText = 'Too many failed attempts. Please try again later.';
      }
      
      showError(errorText);
    } finally {
      loginBtn.disabled = false;
      loginBtn.textContent = 'Sign In';
    }
  });

  function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
  }

  function hideError() {
    errorMessage.classList.add('hidden');
  }
});
</script>
</body>
</html>