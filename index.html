<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Incident Report Feed</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="./styles.css">
<script type="module" src="./firebase-config.js"></script>
</head>
<body class="bg-background-dark">
<div class="container">
<header class="header">
<div class="flex items-center justify-between p-4">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-zinc-900">location_on</span>
<h1 class="text-xl font-bold text-zinc-900">San Francisco</h1>
</div>
<div class="flex items-center gap-2">
<button class="p-2 rounded-full hover-primary">
<span class="material-symbols-outlined text-zinc-900">notifications</span>
</button>
<button id="logout-btn" class="p-2 rounded-full hover-primary" title="Logout">
<span class="material-symbols-outlined text-zinc-900">logout</span>
</button>
</div>
</div>
<div class="px-4 pb-4">
<div class="flex items-center gap-4">
<img alt="Anonymous user avatar" class="w-14 h-14 rounded-full" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCy998_EKxMaodnFCM8aGsWCxqi8SsKu6gsG48ne88fWm1bNMk43V28HtDYo8t0PkB7AMs8roscESwJag_Y96UrEbBN8iU3IVziBjwXm511zu_DJslJhAR4dtoxsKCqAHW60ahzRZK1BR16xclouoPwcZjPJAy3F81zFP3_Il4cofZXoFBcvE-PqZPD9VDMtqI_P0HhLCRIndc_tiS8KtucDgU4TUCBZI1nXrx1atpwM6cMwFsjoCadNmbqv_CMUDVDvo_F6BjKohwJ"/>
<div class="flex-grow">
<p class="font-bold text-zinc-900">Anonymous</p>
<p class="text-sm text-zinc-500">Post an incident to the community</p>
</div>
<a href="./post.html"><button class="btn-primary">Post</button></a>
</div>
</div>
<div class="px-4 pb-2">
<h2 class="text-lg font-bold text-zinc-900">Recent Reports</h2>
</div>
</header>
<main id="reports-container" class="divide-y pb-16">
<div id="loading-state" class="p-4 text-center">
<p class="text-zinc-500">Loading reports...</p>
</div>
</main>
<footer class="footer">
<nav class="flex justify-around items-center h-16">
<a class="nav-item active" href="./index.html">
<span class="material-symbols-outlined">home</span>
<span class="text-xs font-bold">Home</span>
</a>
<a class="nav-item" href="./report.html">
<span class="material-symbols-outlined">description</span>
<span class="text-xs font-medium">Report</span>
</a>
<a class="nav-item" href="./post.html">
<span class="material-symbols-outlined">photo_camera</span>
<span class="text-xs font-medium">Camera</span>
</a>
<a class="nav-item" href="./profile.html">
<span class="material-symbols-outlined">person</span>
<span class="text-xs font-medium">Profile</span>
</a>
</nav>
</footer>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', async function() {
  // Wait for Firebase to initialize
  await new Promise(resolve => {
    const checkReady = () => {
      if (window.authManager && window.reportManager) {
        resolve();
      } else {
        setTimeout(checkReady, 100);
      }
    };
    checkReady();
  });
  const reportsContainer = document.getElementById('reports-container');
  const loadingState = document.getElementById('loading-state');
  let userLocation = null;
  
  // Get user's current location and update header
  async function getCurrentLocationAndUpdateHeader() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) {
        resolve(null);
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        async function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          userLocation = { lat, lng };
          
          try {
            // Get city name from coordinates
            const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
            const data = await response.json();
            
            const city = data.city || data.locality || 'Unknown City';
            const region = data.principalSubdivision || data.region || '';
            
            // Update header location
            const headerLocation = document.querySelector('.flex.items-center.gap-2 h1');
            if (headerLocation) {
              headerLocation.textContent = city + (region ? `, ${region}` : '');
            }
            
            resolve({ city, region, lat, lng });
          } catch (error) {
            console.error('Reverse geocoding failed:', error);
            resolve({ city: 'Unknown Location', region: '', lat, lng });
          }
        },
        function(error) {
          console.error('Geolocation failed:', error);
          resolve(null);
        }
      );
    });
  }
  
  // Calculate distance between two points (Haversine formula)
  function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Earth's radius in kilometers
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // Distance in kilometers
  }
  
  // Filter reports by location proximity (within 50km)
  function filterReportsByLocation(reports) {
    if (!userLocation) return reports; // If no user location, show all reports
    
    return reports.filter(report => {
      if (!report.coordinates) return true; // Include reports without coordinates
      
      const distance = calculateDistance(
        userLocation.lat, userLocation.lng,
        report.coordinates.lat, report.coordinates.lng
      );
      
      return distance <= 50; // Show reports within 50km
    });
  }
  
  try {
    // Get user location first
    await getCurrentLocationAndUpdateHeader();
    
    // Wait for Firebase to initialize
    await new Promise(resolve => {
      const checkReady = () => {
        if (window.reportManager) {
          resolve();
        } else {
          setTimeout(checkReady, 100);
        }
      };
      checkReady();
    });
    
    // Get reports from Firebase
    const allReports = await window.reportManager.getAllReports();
    
    // Filter reports by location proximity
    const reports = filterReportsByLocation(allReports);
    
    // Clear loading state
    loadingState.style.display = 'none';
    
    if (reports.length === 0) {
      reportsContainer.innerHTML = '<div class="p-4 text-center"><p class="text-zinc-500">No reports found. <a href="./post.html" class="text-primary">Create your first report</a></p></div>';
      return;
    }
    
    // Display reports
    reports.forEach(report => {
      const article = document.createElement('article');
      article.className = 'article';
      
      const statusColor = report.status === 'Solved' ? 'text-green-500' : 
                         report.status === 'Pending' ? 'text-yellow-500' : 
                         'text-blue-500';
      
      const createdDate = report.createdAt ? new Date(report.createdAt).toLocaleDateString() : 'Unknown date';
      
      // User display logic
      let userDisplay = 'Anonymous User';
      let userAvatar = 'https://via.placeholder.com/56x56/9ca3af/ffffff?text=A';
      
      if (report.user && report.user.profileVisible) {
        userDisplay = report.user.name || 'Anonymous User';
        userAvatar = report.user.profilePicture || `https://via.placeholder.com/56x56/1193d4/ffffff?text=${userDisplay.charAt(0)}`;
      }
      
      const immediateHelpBadge = report.immediateHelp ? 
        '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-red-100 text-red-800 mb-2"><span class="material-symbols-outlined text-xs mr-1">priority_high</span>Immediate Help</span>' : '';
      
      article.innerHTML = `
        <div class="p-4">
          <!-- User info header -->
          <div class="flex items-center gap-3 mb-3">
            <img src="${userAvatar}" alt="${userDisplay}" class="w-14 h-14 rounded-full">
            <div class="flex-1">
              <p class="font-semibold text-zinc-900">${userDisplay}</p>
              <p class="text-sm text-zinc-500">${createdDate} â€¢ ${report.location || 'Location not specified'}</p>
            </div>
            <button class="p-2 text-zinc-500 hover-primary rounded-full">
              <span class="material-symbols-outlined">more_horiz</span>
            </button>
          </div>
          
          ${immediateHelpBadge}
          
          <div class="relative mb-3">
            ${report.imageUrl ? 
              `<img alt="Report image" class="w-full h-auto rounded-lg" src="${report.imageUrl}"/>` :
              `<div class="w-full h-40 bg-gray-300 rounded-lg flex items-center justify-center">
                <span class="material-symbols-outlined text-gray-500 text-4xl">image</span>
              </div>`
            }
          </div>
          
          <div>
            <h3 class="text-lg font-bold text-zinc-900 mb-2">${report.title || 'Untitled Report'}</h3>
            <p class="text-zinc-600 mb-2">${report.description || 'No description provided'}</p>
            ${report.tags && report.tags.length > 0 ? 
              `<div class="flex flex-wrap gap-1 mb-2">${report.tags.map(tag => `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${tag}</span>`).join('')}</div>` : ''}
            <p class="text-xs ${statusColor}">Status: ${report.status || 'Reported'}</p>
          </div>
        </div>
        <div class="flex justify-around py-3 border-t border-zinc-200">
          <button class="engagement-btn flex items-center gap-2 px-4 py-2 text-zinc-600 hover-primary rounded-full transition-colors" data-type="likes" data-id="${report.id}">
            <span class="material-symbols-outlined">thumb_up</span>
            <span class="text-sm font-semibold">${report.likes || 0}</span>
          </button>
          <button class="engagement-btn flex items-center gap-2 px-4 py-2 text-zinc-600 hover-primary rounded-full transition-colors" data-type="bookmarks" data-id="${report.id}">
            <span class="material-symbols-outlined">bookmark</span>
            <span class="text-sm font-semibold">${report.bookmarks || 0}</span>
          </button>
          <button class="engagement-btn flex items-center gap-2 px-4 py-2 text-zinc-600 hover-primary rounded-full transition-colors" data-type="shares" data-id="${report.id}">
            <span class="material-symbols-outlined">share</span>
            <span class="text-sm font-semibold">${report.shares || 0}</span>
          </button>
        </div>
      `;
      
      reportsContainer.appendChild(article);
    });
    
    // Add engagement button functionality
    document.querySelectorAll('.engagement-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const type = this.getAttribute('data-type');
        const reportId = this.getAttribute('data-id');
        const countSpan = this.querySelector('.text-sm');
        
        try {
          // Update in Firebase
          await window.reportManager.updateEngagement(reportId, type);
          
          // Update UI
          const currentCount = parseInt(countSpan.textContent);
          countSpan.textContent = currentCount + 1;
          
          // Add visual feedback
          this.classList.add('text-primary');
          setTimeout(() => this.classList.remove('text-primary'), 300);
          
        } catch (error) {
          console.error('Error updating engagement:', error);
        }
      });
    });
    
  } catch (error) {
    console.error('Error loading reports:', error);
    loadingState.innerHTML = '<p class="text-red-500">Error loading reports. Please try again later.</p>';
  }
});

// Logout functionality
document.getElementById('logout-btn').addEventListener('click', async function() {
  if (confirm('Are you sure you want to logout?')) {
    try {
      await window.authManager.logout();
      window.location.href = './login.html';
    } catch (error) {
      console.error('Logout error:', error);
    }
  }
});
</script>
</body>
</html>