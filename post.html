<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>New Post</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="./styles.css">
<script type="module" src="./firebase-config.js"></script>
</head>
<body class="bg-background-dark">
<div class="flex flex-col h-screen justify-between">
<div class="flex-grow overflow-y-auto pb-20">
<header class="header px-4 py-3 flex items-center justify-between">
<button class="text-zinc-900">
<span class="material-symbols-outlined">close</span>
</button>
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-zinc-900 text-base">location_on</span>
<span class="text-sm text-zinc-900">New York, NY</span>
</div>
<button id="submit-btn" class="btn-primary">Submit Post</button>
</header>
<main class="p-4 space-y-6">
<div>
<textarea id="description-input" class="form-textarea" placeholder="Describe the incident"></textarea>
</div>
<div>
<h3 class="text-lg font-bold text-zinc-900 mb-2">Add an image</h3>
<div id="image-upload-area" class="bg-white rounded-lg flex items-center justify-center aspect-video border-2 border-dashed border-gray-300 cursor-pointer">
<input type="file" id="image-input" accept="image/*,capture=camera" style="display: none;">
<div class="text-center">
<span class="material-symbols-outlined text-4xl text-gray-400">add_photo_alternate</span>
<p class="text-sm text-gray-500 mt-1">Tap to take photo or select image</p>
</div>
</div>
<div id="image-preview" style="display: none;" class="mt-2">
<img id="preview-image" class="w-full h-auto rounded-lg" alt="Preview">
<button id="remove-image" class="mt-2 btn-secondary text-sm">Remove Image</button>
</div>
</div>
<div>
<h3 class="text-lg font-bold text-zinc-900 mb-2">Location *</h3>
<input id="location-input" class="form-input w-full" type="text" placeholder="Enter incident location" required/>
<button id="get-location-btn" class="mt-2 btn-secondary text-sm">üìç Use Current Location</button>
</div>
<div>
<h3 class="text-lg font-bold text-zinc-900 mb-2">Tags *</h3>
<div id="tags-container" class="flex flex-wrap gap-2 mb-2">
<button class="tag" data-tag="Road Hazard">
Road Hazard
<span class="material-symbols-outlined text-base ml-1">close</span>
</button>
<button class="tag" data-tag="Traffic Accident">
Traffic Accident
<span class="material-symbols-outlined text-base ml-1">close</span>
</button>
<button class="tag" data-tag="Emergency">
Emergency
<span class="material-symbols-outlined text-base ml-1">close</span>
</button>
<button class="tag" data-tag="Infrastructure">
Infrastructure
<span class="material-symbols-outlined text-base ml-1">close</span>
</button>
</div>
<div class="flex gap-2">
<input id="custom-tag-input" class="form-input flex-1" type="text" placeholder="Add custom tag" maxlength="20"/>
<button id="add-tag-btn" class="btn-secondary">Add Tag</button>
</div>
<p class="text-sm text-zinc-500 mt-1">Select existing tags or add your own. At least one tag is required.</p>
</div>
<div>
<div class="flex items-center justify-between bg-white p-3 rounded-lg">
<div>
<h3 class="text-lg font-bold text-zinc-900">Immediate help</h3>
<p class="text-sm text-zinc-500">Mark if this incident requires urgent attention</p>
</div>
<label class="toggle-switch">
<input id="immediate-help-toggle" class="toggle-input" type="checkbox" value=""/>
<div class="toggle-bg"></div>
<div class="toggle-thumb"></div>
</label>
</div>
</div>
</main>
</div>
<footer class="footer">
<nav class="flex justify-around items-center h-16">
<a class="nav-item" href="./index.html">
<span class="material-symbols-outlined">home</span>
<span class="text-xs font-bold">Home</span>
</a>
<a class="nav-item" href="./report.html">
<span class="material-symbols-outlined">description</span>
<span class="text-xs font-medium">Report</span>
</a>
<a class="nav-item active" href="./post.html">
<span class="material-symbols-outlined">photo_camera</span>
<span class="text-xs font-medium">Camera</span>
</a>
<a class="nav-item" href="./profile.html">
<span class="material-symbols-outlined">person</span>
<span class="text-xs font-medium">Profile</span>
</a>
</nav>
</footer>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', async function() {
  // Wait for Firebase to initialize
  await new Promise(resolve => {
    const checkReady = () => {
      if (window.authManager && window.reportManager) {
        resolve();
      } else {
        setTimeout(checkReady, 100);
      }
    };
    checkReady();
  });
  const submitBtn = document.getElementById('submit-btn');
  const descriptionInput = document.getElementById('description-input');
  const locationInput = document.getElementById('location-input');
  const immediateHelpToggle = document.getElementById('immediate-help-toggle');
  const customTagInput = document.getElementById('custom-tag-input');
  const addTagBtn = document.getElementById('add-tag-btn');
  const getLocationBtn = document.getElementById('get-location-btn');
  const tagsContainer = document.getElementById('tags-container');
  const imageUploadArea = document.getElementById('image-upload-area');
  const imageInput = document.getElementById('image-input');
  const imagePreview = document.getElementById('image-preview');
  const previewImage = document.getElementById('preview-image');
  const removeImageBtn = document.getElementById('remove-image');
  
  let selectedTags = new Set();
  
  // Initialize tag functionality
  function initializeTags() {
    // Handle existing tag clicks (toggle selection)
    tagsContainer.addEventListener('click', function(e) {
      const tagButton = e.target.closest('.tag');
      const closeIcon = e.target.closest('.material-symbols-outlined');
      
      if (tagButton) {
        const tagName = tagButton.getAttribute('data-tag');
        
        if (closeIcon || tagButton.classList.contains('tag-selected')) {
          // Remove tag
          selectedTags.delete(tagName);
          tagButton.classList.remove('tag-selected');
        } else {
          // Add tag
          selectedTags.add(tagName);
          tagButton.classList.add('tag-selected');
        }
      }
    });
  }
  
  // Add custom tag functionality
  function addCustomTag() {
    const customTag = customTagInput.value.trim();
    if (!customTag) {
      alert('Please enter a tag name');
      return;
    }
    
    if (customTag.length > 20) {
      alert('Tag name must be 20 characters or less');
      return;
    }
    
    if (selectedTags.has(customTag)) {
      alert('This tag is already selected');
      return;
    }
    
    // Create new tag button
    const tagButton = document.createElement('button');
    tagButton.className = 'tag tag-selected';
    tagButton.setAttribute('data-tag', customTag);
    tagButton.innerHTML = `${customTag}<span class="material-symbols-outlined text-base ml-1">close</span>`;
    
    tagsContainer.appendChild(tagButton);
    selectedTags.add(customTag);
    customTagInput.value = '';
  }
  
  // Get current location with reverse geocoding
  async function getCurrentLocation() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by this browser');
      return;
    }
    
    getLocationBtn.disabled = true;
    getLocationBtn.textContent = 'üìç Getting location...';
    
    navigator.geolocation.getCurrentPosition(
      async function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        try {
          // Use a reverse geocoding service to get readable address
          const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
          const data = await response.json();
          
          const city = data.city || data.locality || 'Unknown City';
          const region = data.principalSubdivision || data.region || '';
          const country = data.countryName || '';
          
          const locationString = `${city}${region ? ', ' + region : ''}${country ? ', ' + country : ''}`;
          locationInput.value = locationString;
          
          // Update the header location as well
          updateHeaderLocation(city, region);
          
        } catch (error) {
          console.error('Reverse geocoding failed:', error);
          locationInput.value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        }
        
        getLocationBtn.disabled = false;
        getLocationBtn.textContent = 'üìç Use Current Location';
      },
      function(error) {
        alert('Unable to retrieve your location: ' + error.message);
        getLocationBtn.disabled = false;
        getLocationBtn.textContent = 'üìç Use Current Location';
      }
    );
  }
  
  // Update header location
  function updateHeaderLocation(city, region) {
    const headerLocation = document.querySelector('.flex.items-center.gap-2 h1');
    if (headerLocation) {
      headerLocation.textContent = city + (region ? `, ${region}` : '');
    }
  }
  
  // Form validation
  function validateForm() {
    const description = descriptionInput.value.trim();
    const location = locationInput.value.trim();
    
    if (!description) {
      alert('Please provide a description for the incident.');
      descriptionInput.focus();
      return false;
    }
    
    if (description.length < 10) {
      alert('Description must be at least 10 characters long.');
      descriptionInput.focus();
      return false;
    }
    
    if (!location) {
      alert('Please provide a location for the incident.');
      locationInput.focus();
      return false;
    }
    
    if (selectedTags.size === 0) {
      alert('Please select at least one tag for the incident.');
      return false;
    }
    
    return true;
  }
  
  // Save report to local storage (temporary solution)
  function saveReport(reportData) {
    try {
      const existingReports = JSON.parse(localStorage.getItem('incident_reports') || '[]');
      reportData.id = Date.now().toString();
      reportData.createdAt = new Date().toISOString();
      reportData.user = { name: 'Anonymous User', profileVisible: true };
      existingReports.unshift(reportData);
      localStorage.setItem('incident_reports', JSON.stringify(existingReports));
      return true;
    } catch (error) {
      console.error('Error saving report:', error);
      return false;
    }
  }
  
  // Image upload functionality
  function initializeImageUpload() {
    imageUploadArea.addEventListener('click', function() {
      imageInput.click();
    });
    
    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          imagePreview.style.display = 'block';
          imageUploadArea.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    });
    
    removeImageBtn.addEventListener('click', function() {
      imageInput.value = '';
      previewImage.src = '';
      imagePreview.style.display = 'none';
      imageUploadArea.style.display = 'flex';
    });
  }
  
  // Event listeners
  addTagBtn.addEventListener('click', addCustomTag);
  customTagInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      addCustomTag();
    }
  });
  
  getLocationBtn.addEventListener('click', getCurrentLocation);
  initializeImageUpload();
  
  submitBtn.addEventListener('click', function(e) {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    try {
      const description = descriptionInput.value.trim();
      const location = locationInput.value.trim();
      const immediateHelp = immediateHelpToggle.checked;
      
      // Extract title from description (first sentence or first 50 chars)
      const title = description.split('.')[0].substring(0, 50) + (description.length > 50 ? '...' : '');
      
      // Handle image if uploaded
      let imageUrl = null;
      if (imageInput.files[0]) {
        const reader = new FileReader();
        imageUrl = await new Promise((resolve) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(imageInput.files[0]);
        });
      }
      
      // Get coordinates for the location if possible
      let coordinates = null;
      try {
        if (navigator.geolocation) {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
          coordinates = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
        }
      } catch (error) {
        console.log('Could not get coordinates for location');
      }
      
      // Create report data
      const reportData = {
        title: title,
        description: description,
        location: location,
        coordinates: coordinates,
        status: 'Reported',
        tags: Array.from(selectedTags),
        likes: 0,
        bookmarks: 0,
        shares: 0,
        immediateHelp: immediateHelp,
        imageUrl: imageUrl
      };
      
      // Save to Firebase instead of local storage
      await window.reportManager.addReport(reportData);
      alert('Report submitted successfully!');
      
      // Reset form
      descriptionInput.value = '';
      locationInput.value = '';
      immediateHelpToggle.checked = false;
      customTagInput.value = '';
      selectedTags.clear();
      
      // Reset image
      imageInput.value = '';
      previewImage.src = '';
      imagePreview.style.display = 'none';
      imageUploadArea.style.display = 'flex';
      
      // Reset tag selection
      document.querySelectorAll('.tag-selected').forEach(tag => {
        tag.classList.remove('tag-selected');
      });
      
      // Redirect to home page
      window.location.href = './index.html';
      
    } catch (error) {
      console.error('Error submitting report:', error);
      alert('Error submitting report. Please try again.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Post';
    }
  });
  
  // Initialize the page
  initializeTags();
});
</script>
</body>
</html>