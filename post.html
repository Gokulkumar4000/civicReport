<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>New Post</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="./styles.css">
<script type="module" src="./firebase-config.js"></script>
</head>
<body class="bg-background-dark">
<div class="flex flex-col h-screen justify-between">
<div class="flex-grow overflow-y-auto">
<header class="header px-4 py-3 flex items-center justify-between">
<button class="text-zinc-900">
<span class="material-symbols-outlined">close</span>
</button>
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-zinc-900 text-base">location_on</span>
<span class="text-sm text-zinc-900">New York, NY</span>
</div>
<button id="submit-btn" class="btn-primary">Submit Post</button>
</header>
<main class="p-4 space-y-6">
<div>
<textarea id="description-input" class="form-textarea" placeholder="Describe the incident"></textarea>
</div>
<div>
<h3 class="text-lg font-bold text-zinc-900 mb-2">Add an image</h3>
<div class="bg-white rounded-lg flex items-center justify-center aspect-video border-2 border-dashed border-gray-300">
<div class="text-center">
<span class="material-symbols-outlined text-4xl text-gray-400">add_photo_alternate</span>
<p class="text-sm text-gray-500 mt-1">Tap to add an image</p>
</div>
</div>
</div>
<div>
<h3 class="text-lg font-bold text-zinc-900 mb-2">Suggested tags</h3>
<div class="flex flex-wrap gap-2">
<button class="tag">
Road Hazard
<span class="material-symbols-outlined text-base ml-1">close</span>
</button>
<button class="tag">
Traffic Accident
<span class="material-symbols-outlined text-base ml-1">close</span>
</button>
<button class="tag-add">
Add Tag
<span class="material-symbols-outlined text-base ml-1">add</span>
</button>
</div>
</div>
<div>
<div class="flex items-center justify-between bg-white p-3 rounded-lg">
<div>
<h3 class="text-lg font-bold text-zinc-900">Immediate help</h3>
<p class="text-sm text-zinc-500">Mark if this incident requires urgent attention</p>
</div>
<label class="toggle-switch">
<input id="immediate-help-toggle" class="toggle-input" type="checkbox" value=""/>
<div class="toggle-bg"></div>
<div class="toggle-thumb"></div>
</label>
</div>
</div>
</main>
</div>
<footer class="footer">
<nav class="flex justify-around items-center h-16">
<a class="nav-item" href="./index.html">
<span class="material-symbols-outlined">home</span>
<span class="text-xs font-bold">Home</span>
</a>
<a class="nav-item" href="./report.html">
<span class="material-symbols-outlined">description</span>
<span class="text-xs font-medium">Report</span>
</a>
<a class="nav-item active" href="./post.html">
<span class="material-symbols-outlined">photo_camera</span>
<span class="text-xs font-medium">Camera</span>
</a>
<a class="nav-item" href="./profile.html">
<span class="material-symbols-outlined">person</span>
<span class="text-xs font-medium">Profile</span>
</a>
</nav>
</footer>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', async function() {
  const submitBtn = document.getElementById('submit-btn');
  const descriptionInput = document.getElementById('description-input');
  const immediateHelpToggle = document.getElementById('immediate-help-toggle');
  
  // Wait for Firebase to initialize and authenticate
  await new Promise(resolve => {
    const checkReady = () => {
      if (window.authManager && window.reportManager) {
        resolve();
      } else {
        setTimeout(checkReady, 100);
      }
    };
    checkReady();
  });
  
  try {
    // Wait for authentication state and require authentication
    await window.authManager.requireAuth();
  } catch (error) {
    alert('Please login to create reports');
    window.location.href = './login.html';
    return;
  }
  
  submitBtn.addEventListener('click', async function(e) {
    e.preventDefault();
    
    const description = descriptionInput.value.trim();
    const immediateHelp = immediateHelpToggle.checked;
    
    if (!description) {
      alert('Please provide a description for the incident.');
      return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    try {
      // Extract title from description (first sentence or first 50 chars)
      const title = description.split('.')[0].substring(0, 50) + (description.length > 50 ? '...' : '');
      
      // Get selected tags
      const selectedTags = Array.from(document.querySelectorAll('.tag')).map(tag => tag.textContent.replace('close', '').trim());
      
      // Create report data
      const reportData = {
        title: title,
        description: description,
        location: 'New York, NY', // You can make this dynamic later
        status: 'Reported',
        tags: selectedTags,
        likes: 0,
        bookmarks: 0,
        shares: 0,
        immediateHelp: immediateHelp,
        imageUrl: null // You can add image upload functionality later
      };
      
      // Save to Firebase
      await window.reportManager.addReport(reportData);
      
      // Success feedback
      alert('Report submitted successfully!');
      
      // Reset form
      descriptionInput.value = '';
      immediateHelpToggle.checked = false;
      
      // Redirect to home page
      window.location.href = './index.html';
      
    } catch (error) {
      console.error('Error submitting report:', error);
      if (error.message.includes('logged in')) {
        alert('Please login to create reports');
        window.location.href = './login.html';
      } else {
        alert('Error submitting report. Please try again.');
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Post';
    }
  });
});
</script>
</body>
</html>