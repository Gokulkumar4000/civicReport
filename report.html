<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Incident Report</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="./styles.css">
<script type="module" src="./firebase-config.js"></script>
</head>
<body class="bg-background-dark">
<div class="flex flex-col h-screen justify-between">
<main class="flex-1 overflow-y-auto">
<header class="header">
<div class="flex items-center p-4">
<button class="p-2 -ml-2 text-gray-800">
<span class="material-symbols-outlined">arrow_back_ios_new</span>
</button>
<h1 class="text-xl font-bold text-gray-900 flex-1 text-center pr-10">Report</h1>
</div>
</header>
<div class="p-4 space-y-6">
<div class="bg-white p-6 rounded-xl shadow-sm">
<p class="text-sm font-medium text-gray-500">Total Cases Solved</p>
<p class="text-4xl font-bold text-gray-900 mt-1">120</p>
</div>
<div class="flex h-12 items-center justify-center rounded-full bg-gray-200 p-1">
<label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-full px-4 text-sm font-medium transition-all duration-300 bg-primary text-white">
<span class="truncate">Reported</span>
<input checked class="sr-only" name="status-filter" type="radio" value="Reported"/>
</label>
<label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-full px-4 text-sm font-medium transition-all duration-300 text-gray-600">
<span class="truncate">Pending</span>
<input class="sr-only" name="status-filter" type="radio" value="Pending"/>
</label>
<label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-full px-4 text-sm font-medium transition-all duration-300 text-gray-600">
<span class="truncate">Solved</span>
<input class="sr-only" name="status-filter" type="radio" value="Solved"/>
</label>
</div>
<div id="reports-list" class="space-y-4">
<div id="loading-reports" class="text-center py-4">
<p class="text-zinc-500">Loading reports...</p>
</div>
</div>
</div>
</main>
<footer class="footer">
<nav class="flex justify-around items-center h-16">
<a class="nav-item" href="./index.html">
<span class="material-symbols-outlined">home</span>
<span class="text-xs font-bold">Home</span>
</a>
<a class="nav-item active" href="./report.html">
<span class="material-symbols-outlined">description</span>
<span class="text-xs font-medium">Report</span>
</a>
<a class="nav-item" href="./post.html">
<span class="material-symbols-outlined">photo_camera</span>
<span class="text-xs font-medium">Camera</span>
</a>
<a class="nav-item" href="./profile.html">
<span class="material-symbols-outlined">person</span>
<span class="text-xs font-medium">Profile</span>
</a>
</nav>
</footer>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', async function() {
  const reportsList = document.getElementById('reports-list');
  const loadingReports = document.getElementById('loading-reports');
  const statusFilters = document.querySelectorAll('input[name="status-filter"]');
  
  let allReports = [];
  
  // Wait for Firebase to initialize and check authentication
  await new Promise(resolve => {
    const checkReady = () => {
      if (window.authManager && window.reportManager) {
        resolve();
      } else {
        setTimeout(checkReady, 100);
      }
    };
    checkReady();
  });
  
  try {
    // Wait for authentication state and require authentication
    await window.authManager.requireAuth();
  } catch (error) {
    alert('Please login to view your reports');
    window.location.href = './login.html';
    return;
  }
  
  // Load current user's reports from Firebase
  async function loadReports() {
    try {
      // Ensure authentication before loading reports
      await window.authManager.requireAuth();
      
      // Get current user's reports only
      allReports = await window.reportManager.getCurrentUserReports();
      loadingReports.style.display = 'none';
      
      // Update total cases count (solved cases by current user)
      const totalCases = document.querySelector('.text-4xl.font-bold');
      if (totalCases) {
        const solvedCount = allReports.filter(report => report.status === 'Solved').length;
        totalCases.textContent = solvedCount;
      }
      
      displayReports(allReports);
      
    } catch (error) {
      console.error('Error loading reports:', error);
      if (error.message.includes('logged in')) {
        alert('Please login to view your reports');
        window.location.href = './login.html';
      } else {
        loadingReports.innerHTML = '<p class="text-red-500">Error loading reports.</p>';
      }
    }
  }
  
  // Display reports based on current filter
  function displayReports(reports) {
    const currentFilter = document.querySelector('input[name="status-filter"]:checked').value;
    
    let filteredReports = reports;
    if (currentFilter !== 'All') {
      filteredReports = reports.filter(report => report.status === currentFilter);
    }
    
    if (filteredReports.length === 0) {
      const filterText = currentFilter === 'All' ? '' : ` with status "${currentFilter}"`;
      reportsList.innerHTML = `<div class="text-center py-8">
        <span class="material-symbols-outlined text-zinc-400 text-4xl">description</span>
        <p class="text-zinc-500 mt-2">No reports found${filterText}.</p>
        <a href="./post.html" class="text-primary font-semibold mt-2 inline-block">Create your first report</a>
      </div>`;
      return;
    }
    
    reportsList.innerHTML = '';
    
    filteredReports.forEach(report => {
      const reportItem = document.createElement('div');
      reportItem.className = 'flex items-start gap-4 rounded-lg bg-white p-4 shadow-sm';
      
      const statusColor = report.status === 'Solved' ? 'text-green-500' : 
                         report.status === 'Pending' ? 'text-yellow-500' : 
                         'text-blue-500';
      
      const createdDate = report.createdAt ? new Date(report.createdAt.toDate()).toLocaleDateString() : 'Unknown date';
      
      const immediateHelpBadge = report.immediateHelp ? 
        '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-red-100 text-red-800 ml-2"><span class="material-symbols-outlined text-xs mr-1">priority_high</span>Urgent</span>' : '';
      
      reportItem.innerHTML = `
        ${report.imageUrl ? 
          `<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-16" style="background-image: url('${report.imageUrl}');"></div>` :
          `<div class="bg-gray-300 aspect-square rounded-lg size-16 flex items-center justify-center">
            <span class="material-symbols-outlined text-gray-500">image</span>
          </div>`
        }
        <div class="flex-1">
          <div class="flex items-center">
            <p class="font-bold text-gray-800">${report.title || 'Untitled Report'}</p>
            ${immediateHelpBadge}
          </div>
          <p class="text-sm text-gray-500 mt-1">
            <span class="font-medium ${statusColor}">Status: ${report.status || 'Reported'}</span>
            <span class="mx-1">â€¢</span>
            <span>${report.likes || 0} likes, ${report.bookmarks || 0} saved, ${report.shares || 0} shares</span>
          </p>
          <p class="text-xs text-gray-400 mt-1">Reported on ${createdDate}</p>
        </div>
        <div class="flex flex-col gap-2">
          <select class="status-select text-sm border border-gray-300 rounded px-2 py-1" data-report-id="${report.id}">
            <option value="Reported" ${report.status === 'Reported' ? 'selected' : ''}>Reported</option>
            <option value="Pending" ${report.status === 'Pending' ? 'selected' : ''}>Pending</option>
            <option value="Solved" ${report.status === 'Solved' ? 'selected' : ''}>Solved</option>
          </select>
          <button class="p-2 text-gray-500 hover-red delete-btn" data-report-id="${report.id}" title="Delete Report">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      `;
      
      reportsList.appendChild(reportItem);
    });
    
    // Add status change functionality
    document.querySelectorAll('.status-select').forEach(select => {
      select.addEventListener('change', async function() {
        const reportId = this.getAttribute('data-report-id');
        const newStatus = this.value;
        
        try {
          await window.reportManager.updateReportStatus(reportId, newStatus);
          // Reload reports to update counts and display
          await loadReports();
        } catch (error) {
          console.error('Error updating status:', error);
          alert('Error updating report status. Please try again.');
        }
      });
    });
    
    // Add delete functionality
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const reportId = this.getAttribute('data-report-id');
        
        if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
          try {
            await window.reportManager.deleteReport(reportId);
            await loadReports(); // Reload reports
          } catch (error) {
            console.error('Error deleting report:', error);
            if (error.message.includes('only delete your own')) {
              alert('You can only delete your own reports.');
            } else {
              alert('Error deleting report. Please try again.');
            }
          }
        }
      });
    });
  }
  
  // Filter functionality
  statusFilters.forEach(filter => {
    filter.addEventListener('change', function() {
      if (this.checked) {
        displayReports(allReports);
      }
    });
  });
  
  // Initial load
  await loadReports();
});
</script>
</body>
</html>