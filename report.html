<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Incident Report</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="./styles.css">
<script type="module" src="./firebase-config.js"></script>
</head>
<body class="bg-background-dark">
<div class="flex flex-col h-screen justify-between">
<main class="flex-1 overflow-y-auto">
<header class="header">
<div class="flex items-center p-4">
<button class="p-2 -ml-2 text-gray-800">
<span class="material-symbols-outlined">arrow_back_ios_new</span>
</button>
<h1 class="text-xl font-bold text-gray-900 flex-1 text-center pr-10">Report</h1>
</div>
</header>
<div class="p-4 space-y-6">
<div class="bg-white p-6 rounded-xl shadow-sm">
<p class="text-sm font-medium text-gray-500">Total Cases Solved</p>
<p class="text-4xl font-bold text-gray-900 mt-1">120</p>
</div>
<div class="flex h-12 items-center justify-center rounded-full bg-gray-200 p-1">
<label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-full px-4 text-sm font-medium transition-all duration-300 bg-primary text-white">
<span class="truncate">Reported</span>
<input checked class="sr-only" name="status-filter" type="radio" value="Reported"/>
</label>
<label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-full px-4 text-sm font-medium transition-all duration-300 text-gray-600">
<span class="truncate">Pending</span>
<input class="sr-only" name="status-filter" type="radio" value="Pending"/>
</label>
<label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-full px-4 text-sm font-medium transition-all duration-300 text-gray-600">
<span class="truncate">Solved</span>
<input class="sr-only" name="status-filter" type="radio" value="Solved"/>
</label>
</div>
<div id="reports-list" class="space-y-4">
<div id="loading-reports" class="text-center py-4">
<p class="text-zinc-500">Loading reports...</p>
</div>
</div>
</div>
</main>
<footer class="footer">
<nav class="flex justify-around items-center h-16">
<a class="nav-item" href="./index.html">
<span class="material-symbols-outlined">home</span>
<span class="text-xs font-bold">Home</span>
</a>
<a class="nav-item active" href="./report.html">
<span class="material-symbols-outlined">description</span>
<span class="text-xs font-medium">Report</span>
</a>
<a class="nav-item" href="./post.html">
<span class="material-symbols-outlined">photo_camera</span>
<span class="text-xs font-medium">Camera</span>
</a>
<a class="nav-item" href="./profile.html">
<span class="material-symbols-outlined">person</span>
<span class="text-xs font-medium">Profile</span>
</a>
</nav>
</footer>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', async function() {
  const reportsList = document.getElementById('reports-list');
  const loadingReports = document.getElementById('loading-reports');
  const statusFilters = document.querySelectorAll('input[name="status-filter"]');
  
  let allReports = [];
  
  // Load reports from Firebase
  async function loadReports() {
    try {
      // Wait for Firebase to initialize
      await new Promise(resolve => {
        const checkReady = () => {
          if (window.reportManager) {
            resolve();
          } else {
            setTimeout(checkReady, 100);
          }
        };
        checkReady();
      });
      
      allReports = await window.reportManager.getAllReports();
      loadingReports.style.display = 'none';
      
      // Update total cases count
      const totalCases = document.querySelector('.text-4xl.font-bold');
      if (totalCases) {
        const solvedCount = allReports.filter(report => report.status === 'Solved').length;
        totalCases.textContent = solvedCount;
      }
      
      displayReports(allReports);
      
    } catch (error) {
      console.error('Error loading reports:', error);
      loadingReports.innerHTML = '<p class="text-red-500">Error loading reports.</p>';
    }
  }
  
  // Display reports based on current filter
  function displayReports(reports) {
    const currentFilter = document.querySelector('input[name="status-filter"]:checked').value;
    
    let filteredReports = reports;
    if (currentFilter !== 'All') {
      filteredReports = reports.filter(report => report.status === currentFilter);
    }
    
    if (filteredReports.length === 0) {
      reportsList.innerHTML = '<div class="text-center py-4"><p class="text-zinc-500">No reports found for this filter.</p></div>';
      return;
    }
    
    reportsList.innerHTML = '';
    
    filteredReports.forEach(report => {
      const reportItem = document.createElement('div');
      reportItem.className = 'flex items-start gap-4 rounded-lg bg-white p-4 shadow-sm';
      
      const statusColor = report.status === 'Solved' ? 'text-green-500' : 
                         report.status === 'Pending' ? 'text-yellow-500' : 
                         'text-blue-500';
      
      const createdDate = report.createdAt ? new Date(report.createdAt.toDate()).toLocaleDateString() : 'Unknown date';
      
      reportItem.innerHTML = `
        ${report.imageUrl ? 
          `<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-16" style="background-image: url('${report.imageUrl}');"></div>` :
          `<div class="bg-gray-300 aspect-square rounded-lg size-16 flex items-center justify-center">
            <span class="material-symbols-outlined text-gray-500">image</span>
          </div>`
        }
        <div class="flex-1">
          <p class="font-bold text-gray-800">${report.title || 'Untitled Report'}</p>
          <p class="text-sm text-gray-500 mt-1"><span class="font-medium ${statusColor}">Status: ${report.status || 'Reported'}</span></p>
          <p class="text-xs text-gray-400 mt-1">Reported on ${createdDate}</p>
        </div>
        <button class="p-2 text-gray-500 hover-red delete-btn" data-report-id="${report.id}">
          <span class="material-symbols-outlined">delete</span>
        </button>
      `;
      
      reportsList.appendChild(reportItem);
    });
    
    // Add delete functionality
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const reportId = this.getAttribute('data-report-id');
        
        if (confirm('Are you sure you want to delete this report?')) {
          try {
            await window.reportManager.deleteReport(reportId);
            await loadReports(); // Reload reports
          } catch (error) {
            console.error('Error deleting report:', error);
            alert('Error deleting report. Please try again.');
          }
        }
      });
    });
  }
  
  // Filter functionality
  statusFilters.forEach(filter => {
    filter.addEventListener('change', function() {
      if (this.checked) {
        displayReports(allReports);
      }
    });
  });
  
  // Initial load
  await loadReports();
});
</script>
</body>
</html>